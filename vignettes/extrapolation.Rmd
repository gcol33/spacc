---
title: "Extrapolation and Species-Area Models"
author: "Gilles Colling"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Extrapolation and Species-Area Models}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5
)
```

## Overview

spacc provides tools for estimating total species richness beyond
observed sampling effort: asymptotic model fitting, coverage-based
extrapolation, and diversity-area relationships (DAR).

## Data Setup

```{r simulate}
library(spacc)

set.seed(42)
n_sites <- 100
n_species <- 50

coords <- data.frame(
  x = runif(n_sites, 0, 100),
  y = runif(n_sites, 0, 100)
)

species <- matrix(0L, n_sites, n_species)
for (sp in seq_len(n_species)) {
  cx <- runif(1, 10, 90)
  cy <- runif(1, 10, 90)
  lambda <- 4 * exp(-0.0008 * ((coords$x - cx)^2 + (coords$y - cy)^2))
  species[, sp] <- rpois(n_sites, lambda)
}
colnames(species) <- paste0("sp", seq_len(n_species))
pa <- (species > 0) * 1L
```

## Asymptotic Extrapolation

`extrapolate()` fits an asymptotic model to the mean accumulation curve
to estimate total species richness:

```{r sac}
sac <- spacc(pa, coords, n_seeds = 30, progress = FALSE)
```

### Model Comparison

spacc supports six asymptotic models. Compare them to select the best
fit:

```{r models}
models <- c("michaelis-menten", "lomolino", "asymptotic", "weibull", "logistic")
fits <- lapply(models, function(m) extrapolate(sac, model = m))
names(fits) <- models

# Compare AIC
data.frame(
  model = models,
  asymptote = sapply(fits, function(f) round(f$asymptote, 1)),
  AIC = sapply(fits, function(f) round(f$aic, 1))
)
```

```{r plot-best, fig.cap = "Best-fitting asymptotic model."}
best <- fits[[which.min(sapply(fits, function(f) f$aic))]]
plot(best)
```

### EVT Model

The Extreme Value Theory model (Borda-de-Agua et al. 2025) uses a
two-component Weibull mixture to capture the triphasic pattern
observed in empirical species-area relationships:

```{r evt}
fit_evt <- extrapolate(sac, model = "evt")
fit_evt
```

The EVT model requires sufficient data points (>10) and works best with
real ecological data exhibiting a clear triphasic SAR pattern.

## Coverage-Based Extrapolation

`extrapolateCoverage()` estimates richness at coverage levels beyond
the observed maximum, using asymptotic estimators (Chao et al. 2014):

```{r cov-extrap}
cov <- spaccCoverage(species, coords, n_seeds = 20, progress = FALSE)

ext <- extrapolateCoverage(cov, target_coverage = c(0.95, 0.99, 1.0), q = 0)
ext
```

```{r plot-cov-extrap, fig.cap = "Coverage-based extrapolation of species richness."}
plot(ext)
```

This is particularly useful when comparing communities with different
abundances â€” standardizing by coverage ensures equal completeness rather
than equal sample size.

## Diversity-Area Relationship (DAR)

`dar()` fits the relationship between diversity (Hill numbers) and area
(Ma 2018). This generalises the classical species-area relationship to
all Hill number orders:

```{r dar, eval = requireNamespace("sf", quietly = TRUE)}
dar_result <- dar(species, coords, q = c(0, 1, 2), n_seeds = 20, progress = FALSE)
dar_result
```

```{r plot-dar, fig.cap = "Diversity-area relationship for q = 0, 1, 2.", eval = requireNamespace("sf", quietly = TRUE)}
plot(dar_result)
```

The DAR captures how diversity scales with area. For q=0 this reduces to
the classical SAR; for higher q it quantifies how evenness scales
spatially.

## Predicting Richness at New Effort Levels

Use `predict()` on a fitted extrapolation model:

```{r predict}
predict(best, n = c(50, 100, 200, 500))
```

## References

- Borda-de-Agua, L., Whittaker, R.J., Cardoso, P., et al. (2025).
  Extreme value theory explains the topography and scaling of the
  species-area relationship. Nature Communications, 16, 5346.
- Chao, A., Gotelli, N.J., Hsieh, T.C., et al. (2014). Rarefaction and
  extrapolation with Hill numbers. Ecological Monographs, 84, 45-67.
- Lomolino, M.V. (2000). Ecology's most general, yet protean pattern:
  the species-area relationship. Journal of Biogeography, 27, 17-26.
- Ma, Z. (2018). Generalizing the species-area relationship with
  diversity-area relationships. Ecology and Evolution, 8, 8645-8655.
