<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>spacc v0.2.0 Implementation Plan • spacc</title><script src="lightswitch.js"></script><script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><link href="extra.css" rel="stylesheet"><meta property="og:title" content="spacc v0.2.0 Implementation Plan"></head><body><p>








  pkgdown/mathjax-config.html

  

  </p>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">spacc</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/gcol33/spacc"><span class="fa fab fa-github"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch"><li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul></li>
      </ul></div>


  </div>
</nav><div class="container template-title-body">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>spacc v0.2.0 Implementation Plan</h1>
      <small class="dont-index">Source: <a href="https://github.com/gcol33/spacc/blob/HEAD/IMPLEMENTATION_PLAN.md" class="external-link"><code>IMPLEMENTATION_PLAN.md</code></a></small>
    </div>

<div id="spacc-v020-implementation-plan" class="section level1">

<p>Four major features to make spacc paper-worthy for Methods in Ecology and Evolution.</p>
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a></h2>
<table class="table"><thead><tr><th>Feature</th>
<th>Priority</th>
<th>Effort</th>
<th>Paper Impact</th>
</tr></thead><tbody><tr><td>Hill Numbers</td>
<td>1</td>
<td>Medium</td>
<td>High</td>
</tr><tr><td>Spatial Beta Diversity</td>
<td>2</td>
<td>Medium</td>
<td>High</td>
</tr><tr><td>Coverage-Based Rarefaction</td>
<td>3</td>
<td>Low</td>
<td>Medium</td>
</tr><tr><td>Phylogenetic/Functional</td>
<td>4</td>
<td>High</td>
<td>High</td>
</tr></tbody></table><hr></div>
<div class="section level2">
<h2 id="feature-1-hill-numbers-for-spatial-sacs">Feature 1: Hill Numbers for Spatial SACs<a class="anchor" aria-label="anchor" href="#feature-1-hill-numbers-for-spatial-sacs"></a></h2>
<div class="section level3">
<h3 id="background">Background<a class="anchor" aria-label="anchor" href="#background"></a></h3>
<p>Hill numbers unify diversity measures: - q = 0: Species richness (current spacc) - q = 1: Exponential of Shannon entropy (effective number of common species) - q = 2: Inverse Simpson (effective number of dominant species)</p>
<p>Formula: <code>qD = (Σ p_i^q)^(1/(1-q))</code> where p_i = relative abundance</p>
</div>
<div class="section level3">
<h3 id="api-design">API Design<a class="anchor" aria-label="anchor" href="#api-design"></a></h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extend existing spacc() with q parameter</span></span>
<span><span class="fu"><a href="reference/spacc.html">spacc</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">coords</span>, method <span class="op">=</span> <span class="st">"knn"</span>, q <span class="op">=</span> <span class="fl">0</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Or create dedicated function</span></span>
<span><span class="fu">hillspacc</span><span class="op">(</span><span class="va">x</span>, <span class="va">coords</span>, method <span class="op">=</span> <span class="st">"knn"</span>, q <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Return object includes curves for each q value</span></span></code></pre></div>
<p><strong>Recommendation</strong>: Add <code>q</code> parameter to <code><a href="reference/spacc.html">spacc()</a></code> for simplicity. Default <code>q = 0</code> maintains backward compatibility.</p>
</div>
<div class="section level3">
<h3 id="implementation">Implementation<a class="anchor" aria-label="anchor" href="#implementation"></a></h3>
<div class="section level4">
<h4 id="r-changes-rspaccr">R Changes (R/spacc.R)<a class="anchor" aria-label="anchor" href="#r-changes-rspaccr"></a></h4>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spacc</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>,</span>
<span>                  <span class="va">coords</span>,</span>
<span>                  <span class="va">n_seeds</span> <span class="op">=</span> <span class="fl">50L</span>,</span>
<span>                  <span class="va">method</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"knn"</span>, <span class="st">"kncn"</span>, <span class="st">"random"</span>, <span class="st">"radius"</span>, <span class="st">"gaussian"</span>, <span class="st">"cone"</span>, <span class="st">"collector"</span><span class="op">)</span>,</span>
<span>                  <span class="va">distance</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"euclidean"</span>, <span class="st">"haversine"</span><span class="op">)</span>,</span>
<span>                  <span class="va">q</span> <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                  <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="co"># Validate q</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="st">"q must be &gt;= 0"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">q</span> <span class="op">&gt;=</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># If abundance data and q &gt; 0, need to track abundances not just presence</span></span>
<span>  <span class="va">use_abundance</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">q</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Call appropriate C++ function</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">use_abundance</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">curves</span> <span class="op">&lt;-</span> <span class="fu">cpp_knn_hill_parallel</span><span class="op">(</span><span class="va">x</span>, <span class="va">dist_mat</span>, <span class="va">n_seeds</span>, <span class="va">q</span>, <span class="va">n_cores</span>, <span class="va">progress</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">curves</span> <span class="op">&lt;-</span> <span class="fu">cpp_knn_parallel</span><span class="op">(</span><span class="va">species_pa</span>, <span class="va">dist_mat</span>, <span class="va">n_seeds</span>, <span class="va">n_cores</span>, <span class="va">progress</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="c-changes-srchillcpp">C++ Changes (src/hill.cpp)<a class="anchor" aria-label="anchor" href="#c-changes-srchillcpp"></a></h4>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co">// Hill number calculation for a set of abundances</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="dt">double</span> calc_hill<span class="op">(</span><span class="at">const</span> <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;&amp;</span> abundances<span class="op">,</span> <span class="dt">double</span> q<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>  <span class="dt">int</span> N <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> a <span class="op">:</span> abundances<span class="op">)</span> N <span class="op">+=</span> a<span class="op">;</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>N <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="cf">return</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>q <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a>    <span class="co">// Species richness</span></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a>    <span class="dt">int</span> S <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> a <span class="op">:</span> abundances<span class="op">)</span> <span class="cf">if</span> <span class="op">(</span>a <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> S<span class="op">++;</span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">(</span><span class="dt">double</span><span class="op">)</span>S<span class="op">;</span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span><span class="bu">std::</span>abs<span class="op">(</span>q <span class="op">-</span> <span class="fl">1.0</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">1e-10</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a>    <span class="co">// Shannon (limit as q -&gt; 1)</span></span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a>    <span class="dt">double</span> H <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> a <span class="op">:</span> abundances<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>a <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a>        <span class="dt">double</span> p <span class="op">=</span> <span class="op">(</span><span class="dt">double</span><span class="op">)</span>a <span class="op">/</span> N<span class="op">;</span></span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a>        H <span class="op">-=</span> p <span class="op">*</span> <span class="bu">std::</span>log<span class="op">(</span>p<span class="op">);</span></span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">std::</span>exp<span class="op">(</span>H<span class="op">);</span></span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a>    <span class="co">// General Hill number</span></span>
<span id="cb3-24"><a href="#cb3-24" tabindex="-1"></a>    <span class="dt">double</span> sum <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb3-25"><a href="#cb3-25" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> a <span class="op">:</span> abundances<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-26"><a href="#cb3-26" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>a <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-27"><a href="#cb3-27" tabindex="-1"></a>        <span class="dt">double</span> p <span class="op">=</span> <span class="op">(</span><span class="dt">double</span><span class="op">)</span>a <span class="op">/</span> N<span class="op">;</span></span>
<span id="cb3-28"><a href="#cb3-28" tabindex="-1"></a>        sum <span class="op">+=</span> <span class="bu">std::</span>pow<span class="op">(</span>p<span class="op">,</span> q<span class="op">);</span></span>
<span id="cb3-29"><a href="#cb3-29" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb3-30"><a href="#cb3-30" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-31"><a href="#cb3-31" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">std::</span>pow<span class="op">(</span>sum<span class="op">,</span> <span class="fl">1.0</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1.0</span> <span class="op">-</span> q<span class="op">));</span></span>
<span id="cb3-32"><a href="#cb3-32" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-33"><a href="#cb3-33" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-34"><a href="#cb3-34" tabindex="-1"></a></span>
<span id="cb3-35"><a href="#cb3-35" tabindex="-1"></a><span class="co">// Single kNN accumulation with Hill numbers</span></span>
<span id="cb3-36"><a href="#cb3-36" tabindex="-1"></a>NumericMatrix cpp_knn_hill_single<span class="op">(</span>IntegerMatrix species_mat<span class="op">,</span></span>
<span id="cb3-37"><a href="#cb3-37" tabindex="-1"></a>                                   NumericMatrix dist_mat<span class="op">,</span></span>
<span id="cb3-38"><a href="#cb3-38" tabindex="-1"></a>                                   <span class="dt">int</span> seed<span class="op">,</span></span>
<span id="cb3-39"><a href="#cb3-39" tabindex="-1"></a>                                   NumericVector q_values<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-40"><a href="#cb3-40" tabindex="-1"></a>  <span class="dt">int</span> n_sites <span class="op">=</span> species_mat<span class="op">.</span>nrow<span class="op">();</span></span>
<span id="cb3-41"><a href="#cb3-41" tabindex="-1"></a>  <span class="dt">int</span> n_species <span class="op">=</span> species_mat<span class="op">.</span>ncol<span class="op">();</span></span>
<span id="cb3-42"><a href="#cb3-42" tabindex="-1"></a>  <span class="dt">int</span> n_q <span class="op">=</span> q_values<span class="op">.</span>size<span class="op">();</span></span>
<span id="cb3-43"><a href="#cb3-43" tabindex="-1"></a></span>
<span id="cb3-44"><a href="#cb3-44" tabindex="-1"></a>  NumericMatrix curves<span class="op">(</span>n_q<span class="op">,</span> n_sites<span class="op">);</span></span>
<span id="cb3-45"><a href="#cb3-45" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">bool</span><span class="op">&gt;</span> visited<span class="op">(</span>n_sites<span class="op">,</span> <span class="kw">false</span><span class="op">);</span></span>
<span id="cb3-46"><a href="#cb3-46" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> cumulative_abundance<span class="op">(</span>n_species<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb3-47"><a href="#cb3-47" tabindex="-1"></a></span>
<span id="cb3-48"><a href="#cb3-48" tabindex="-1"></a>  <span class="dt">int</span> current <span class="op">=</span> seed<span class="op">;</span></span>
<span id="cb3-49"><a href="#cb3-49" tabindex="-1"></a>  visited<span class="op">[</span>current<span class="op">]</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb3-50"><a href="#cb3-50" tabindex="-1"></a></span>
<span id="cb3-51"><a href="#cb3-51" tabindex="-1"></a>  <span class="co">// Add first site abundances</span></span>
<span id="cb3-52"><a href="#cb3-52" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> sp <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> sp <span class="op">&lt;</span> n_species<span class="op">;</span> sp<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb3-53"><a href="#cb3-53" tabindex="-1"></a>    cumulative_abundance<span class="op">[</span>sp<span class="op">]</span> <span class="op">+=</span> species_mat<span class="op">(</span>current<span class="op">,</span> sp<span class="op">);</span></span>
<span id="cb3-54"><a href="#cb3-54" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-55"><a href="#cb3-55" tabindex="-1"></a></span>
<span id="cb3-56"><a href="#cb3-56" tabindex="-1"></a>  <span class="co">// Calculate Hill numbers for each q</span></span>
<span id="cb3-57"><a href="#cb3-57" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> qi <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> qi <span class="op">&lt;</span> n_q<span class="op">;</span> qi<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb3-58"><a href="#cb3-58" tabindex="-1"></a>    curves<span class="op">(</span>qi<span class="op">,</span> <span class="dv">0</span><span class="op">)</span> <span class="op">=</span> calc_hill<span class="op">(</span>cumulative_abundance<span class="op">,</span> q_values<span class="op">[</span>qi<span class="op">]);</span></span>
<span id="cb3-59"><a href="#cb3-59" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-60"><a href="#cb3-60" tabindex="-1"></a></span>
<span id="cb3-61"><a href="#cb3-61" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> step <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> step <span class="op">&lt;</span> n_sites<span class="op">;</span> step<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb3-62"><a href="#cb3-62" tabindex="-1"></a>    <span class="co">// Find nearest unvisited</span></span>
<span id="cb3-63"><a href="#cb3-63" tabindex="-1"></a>    <span class="dt">double</span> min_dist <span class="op">=</span> R_PosInf<span class="op">;</span></span>
<span id="cb3-64"><a href="#cb3-64" tabindex="-1"></a>    <span class="dt">int</span> next <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb3-65"><a href="#cb3-65" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> n_sites<span class="op">;</span> j<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb3-66"><a href="#cb3-66" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(!</span>visited<span class="op">[</span>j<span class="op">]</span> <span class="op">&amp;&amp;</span> dist_mat<span class="op">(</span>current<span class="op">,</span> j<span class="op">)</span> <span class="op">&lt;</span> min_dist<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-67"><a href="#cb3-67" tabindex="-1"></a>        min_dist <span class="op">=</span> dist_mat<span class="op">(</span>current<span class="op">,</span> j<span class="op">);</span></span>
<span id="cb3-68"><a href="#cb3-68" tabindex="-1"></a>        next <span class="op">=</span> j<span class="op">;</span></span>
<span id="cb3-69"><a href="#cb3-69" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb3-70"><a href="#cb3-70" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-71"><a href="#cb3-71" tabindex="-1"></a></span>
<span id="cb3-72"><a href="#cb3-72" tabindex="-1"></a>    current <span class="op">=</span> next<span class="op">;</span></span>
<span id="cb3-73"><a href="#cb3-73" tabindex="-1"></a>    visited<span class="op">[</span>current<span class="op">]</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb3-74"><a href="#cb3-74" tabindex="-1"></a></span>
<span id="cb3-75"><a href="#cb3-75" tabindex="-1"></a>    <span class="co">// Accumulate abundances</span></span>
<span id="cb3-76"><a href="#cb3-76" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> sp <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> sp <span class="op">&lt;</span> n_species<span class="op">;</span> sp<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb3-77"><a href="#cb3-77" tabindex="-1"></a>      cumulative_abundance<span class="op">[</span>sp<span class="op">]</span> <span class="op">+=</span> species_mat<span class="op">(</span>current<span class="op">,</span> sp<span class="op">);</span></span>
<span id="cb3-78"><a href="#cb3-78" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-79"><a href="#cb3-79" tabindex="-1"></a></span>
<span id="cb3-80"><a href="#cb3-80" tabindex="-1"></a>    <span class="co">// Calculate Hill numbers</span></span>
<span id="cb3-81"><a href="#cb3-81" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> qi <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> qi <span class="op">&lt;</span> n_q<span class="op">;</span> qi<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb3-82"><a href="#cb3-82" tabindex="-1"></a>      curves<span class="op">(</span>qi<span class="op">,</span> step<span class="op">)</span> <span class="op">=</span> calc_hill<span class="op">(</span>cumulative_abundance<span class="op">,</span> q_values<span class="op">[</span>qi<span class="op">]);</span></span>
<span id="cb3-83"><a href="#cb3-83" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-84"><a href="#cb3-84" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb3-85"><a href="#cb3-85" tabindex="-1"></a></span>
<span id="cb3-86"><a href="#cb3-86" tabindex="-1"></a>  <span class="cf">return</span> curves<span class="op">;</span></span>
<span id="cb3-87"><a href="#cb3-87" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="new-s3-class-spacc_hill">New S3 Class: spacc_hill<a class="anchor" aria-label="anchor" href="#new-s3-class-spacc_hill"></a></h4>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Return structure</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    curves <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>q0 <span class="op">=</span> <span class="va">matrix</span>, q1 <span class="op">=</span> <span class="va">matrix</span>, q2 <span class="op">=</span> <span class="va">matrix</span><span class="op">)</span>,</span>
<span>    q <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>    coords <span class="op">=</span> <span class="va">coord_data</span>,</span>
<span>    n_seeds <span class="op">=</span> <span class="va">n_seeds</span>,</span>
<span>    n_sites <span class="op">=</span> <span class="va">n_sites</span>,</span>
<span>    n_species <span class="op">=</span> <span class="va">n_species_total</span>,</span>
<span>    method <span class="op">=</span> <span class="va">method</span>,</span>
<span>    call <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/match.call.html" class="external-link">match.call</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"spacc_hill"</span>, <span class="st">"spacc"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="plot-method">Plot Method<a class="anchor" aria-label="anchor" href="#plot-method"></a></h3>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot.spacc_hill</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">q</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">ci</span> <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># If q not specified, plot all</span></span>
<span>  <span class="va">q_vals</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">q</span><span class="op">)</span><span class="op">)</span> <span class="va">x</span><span class="op">$</span><span class="va">q</span> <span class="kw">else</span> <span class="va">q</span></span>
<span></span>
<span>  <span class="co"># Create faceted plot with one panel per q value</span></span>
<span>  <span class="co"># Or overlay with different colors</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="tests">Tests<a class="anchor" aria-label="anchor" href="#tests"></a></h3>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">test_that</span><span class="op">(</span><span class="st">"Hill numbers are correct"</span>, <span class="op">{</span></span>
<span>  <span class="co"># Known community: 10 species, abundances 1:10</span></span>
<span>  <span class="co"># q=0 should give 10</span></span>
<span>  <span class="co"># q=1 should give exp(Shannon)</span></span>
<span>  <span class="co"># q=2 should give 1/Simpson</span></span>
<span></span>
<span>  <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, nrow <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">coords</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">0</span>, y <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="reference/spacc.html">spacc</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">coords</span>, method <span class="op">=</span> <span class="st">"collector"</span>, q <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">expect_equal</span><span class="op">(</span><span class="va">result</span><span class="op">$</span><span class="va">curves</span><span class="op">$</span><span class="va">q0</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">]</span>, <span class="fl">10</span><span class="op">)</span></span>
<span>  <span class="co"># ... verify against vegan::diversity()</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<hr></div>
</div>
<div class="section level2">
<h2 id="feature-2-spatial-beta-diversity-accumulation">Feature 2: Spatial Beta Diversity Accumulation<a class="anchor" aria-label="anchor" href="#feature-2-spatial-beta-diversity-accumulation"></a></h2>
<div class="section level3">
<h3 id="background-1">Background<a class="anchor" aria-label="anchor" href="#background-1"></a></h3>
<p>Beta diversity measures compositional change. As we accumulate sites spatially: - <strong>Turnover</strong>: Species replacement (A has species X, B has species Y) - <strong>Nestedness</strong>: Species loss (B is a subset of A)</p>
<p>Baselga (2010) framework: β_total = β_turnover + β_nestedness</p>
</div>
<div class="section level3">
<h3 id="api-design-1">API Design<a class="anchor" aria-label="anchor" href="#api-design-1"></a></h3>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># New function</span></span>
<span><span class="fu"><a href="reference/spaccBeta.html">spaccBeta</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">coords</span>, method <span class="op">=</span> <span class="st">"knn"</span>, n_seeds <span class="op">=</span> <span class="fl">50</span>,</span>
<span>          partition <span class="op">=</span> <span class="cn">TRUE</span>, index <span class="op">=</span> <span class="st">"sorensen"</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Returns beta diversity vs cumulative sites/distance</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="implementation-1">Implementation<a class="anchor" aria-label="anchor" href="#implementation-1"></a></h3>
<div class="section level4">
<h4 id="core-algorithm">Core Algorithm<a class="anchor" aria-label="anchor" href="#core-algorithm"></a></h4>
<p>At each step of spatial accumulation: 1. Track species composition of accumulated set 2. Compare to previous step (pairwise) OR to all accumulated (cumulative) 3. Partition into turnover and nestedness components</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Sorensen-based dissimilarity</span></span>
<span><span class="va">beta_sor</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span>, <span class="va">c</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># a = shared species, b = unique to site 1, c = unique to site 2</span></span>
<span>  <span class="op">(</span><span class="va">b</span> <span class="op">+</span> <span class="va">c</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">a</span> <span class="op">+</span> <span class="va">b</span> <span class="op">+</span> <span class="va">c</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Turnover component (Simpson)</span></span>
<span><span class="va">beta_sim</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span>, <span class="va">c</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">b</span>, <span class="va">c</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">a</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">b</span>, <span class="va">c</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Nestedness component</span></span>
<span><span class="va">beta_nes</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span>, <span class="va">c</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">beta_sor</span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span>, <span class="va">c</span><span class="op">)</span> <span class="op">-</span> <span class="fu">beta_sim</span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span>, <span class="va">c</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="c-implementation-srcbetacpp">C++ Implementation (src/beta.cpp)<a class="anchor" aria-label="anchor" href="#c-implementation-srcbetacpp"></a></h4>
<div class="sourceCode" id="cb9"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="kw">struct</span> BetaResult <span class="op">{</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>  <span class="dt">double</span> total<span class="op">;</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>  <span class="dt">double</span> turnover<span class="op">;</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>  <span class="dt">double</span> nestedness<span class="op">;</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>BetaResult calc_beta_sorensen<span class="op">(</span><span class="at">const</span> <span class="bu">std::</span>set<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;&amp;</span> set1<span class="op">,</span></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>                               <span class="at">const</span> <span class="bu">std::</span>set<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;&amp;</span> set2<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a>  <span class="dt">int</span> a <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>  <span class="co">// shared</span></span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>  <span class="dt">int</span> b <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>  <span class="co">// unique to set1</span></span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a>  <span class="dt">int</span> c <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>  <span class="co">// unique to set2</span></span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> sp <span class="op">:</span> set1<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>set2<span class="op">.</span>count<span class="op">(</span>sp<span class="op">))</span> a<span class="op">++;</span></span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a>    <span class="cf">else</span> b<span class="op">++;</span></span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> sp <span class="op">:</span> set2<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(!</span>set1<span class="op">.</span>count<span class="op">(</span>sp<span class="op">))</span> c<span class="op">++;</span></span>
<span id="cb9-19"><a href="#cb9-19" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb9-20"><a href="#cb9-20" tabindex="-1"></a></span>
<span id="cb9-21"><a href="#cb9-21" tabindex="-1"></a>  BetaResult result<span class="op">;</span></span>
<span id="cb9-22"><a href="#cb9-22" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>a <span class="op">+</span> b <span class="op">+</span> c <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-23"><a href="#cb9-23" tabindex="-1"></a>    result<span class="op">.</span>total <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb9-24"><a href="#cb9-24" tabindex="-1"></a>    result<span class="op">.</span>turnover <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb9-25"><a href="#cb9-25" tabindex="-1"></a>    result<span class="op">.</span>nestedness <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb9-26"><a href="#cb9-26" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb9-27"><a href="#cb9-27" tabindex="-1"></a>    result<span class="op">.</span>total <span class="op">=</span> <span class="op">(</span><span class="dt">double</span><span class="op">)(</span>b <span class="op">+</span> c<span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">2.0</span><span class="op">*</span>a <span class="op">+</span> b <span class="op">+</span> c<span class="op">);</span></span>
<span id="cb9-28"><a href="#cb9-28" tabindex="-1"></a>    result<span class="op">.</span>turnover <span class="op">=</span> <span class="op">(</span><span class="dt">double</span><span class="op">)</span><span class="bu">std::</span>min<span class="op">(</span>b<span class="op">,</span> c<span class="op">)</span> <span class="op">/</span> <span class="op">(</span>a <span class="op">+</span> <span class="bu">std::</span>min<span class="op">(</span>b<span class="op">,</span> c<span class="op">));</span></span>
<span id="cb9-29"><a href="#cb9-29" tabindex="-1"></a>    result<span class="op">.</span>nestedness <span class="op">=</span> result<span class="op">.</span>total <span class="op">-</span> result<span class="op">.</span>turnover<span class="op">;</span></span>
<span id="cb9-30"><a href="#cb9-30" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb9-31"><a href="#cb9-31" tabindex="-1"></a>  <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb9-32"><a href="#cb9-32" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb9-33"><a href="#cb9-33" tabindex="-1"></a></span>
<span id="cb9-34"><a href="#cb9-34" tabindex="-1"></a><span class="co">// Track cumulative beta as sites are added</span></span>
<span id="cb9-35"><a href="#cb9-35" tabindex="-1"></a>List cpp_beta_accumulation<span class="op">(</span>IntegerMatrix species_pa<span class="op">,</span></span>
<span id="cb9-36"><a href="#cb9-36" tabindex="-1"></a>                           NumericMatrix dist_mat<span class="op">,</span></span>
<span id="cb9-37"><a href="#cb9-37" tabindex="-1"></a>                           <span class="dt">int</span> seed<span class="op">,</span></span>
<span id="cb9-38"><a href="#cb9-38" tabindex="-1"></a>                           <span class="bu">std::</span>string method<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-39"><a href="#cb9-39" tabindex="-1"></a>  <span class="dt">int</span> n_sites <span class="op">=</span> species_pa<span class="op">.</span>nrow<span class="op">();</span></span>
<span id="cb9-40"><a href="#cb9-40" tabindex="-1"></a>  <span class="dt">int</span> n_species <span class="op">=</span> species_pa<span class="op">.</span>ncol<span class="op">();</span></span>
<span id="cb9-41"><a href="#cb9-41" tabindex="-1"></a></span>
<span id="cb9-42"><a href="#cb9-42" tabindex="-1"></a>  NumericVector beta_total<span class="op">(</span>n_sites <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb9-43"><a href="#cb9-43" tabindex="-1"></a>  NumericVector beta_turn<span class="op">(</span>n_sites <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb9-44"><a href="#cb9-44" tabindex="-1"></a>  NumericVector beta_nest<span class="op">(</span>n_sites <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb9-45"><a href="#cb9-45" tabindex="-1"></a>  NumericVector distances<span class="op">(</span>n_sites <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb9-46"><a href="#cb9-46" tabindex="-1"></a></span>
<span id="cb9-47"><a href="#cb9-47" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">bool</span><span class="op">&gt;</span> visited<span class="op">(</span>n_sites<span class="op">,</span> <span class="kw">false</span><span class="op">);</span></span>
<span id="cb9-48"><a href="#cb9-48" tabindex="-1"></a>  <span class="bu">std::</span>set<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> prev_species<span class="op">;</span></span>
<span id="cb9-49"><a href="#cb9-49" tabindex="-1"></a>  <span class="bu">std::</span>set<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> curr_species<span class="op">;</span></span>
<span id="cb9-50"><a href="#cb9-50" tabindex="-1"></a></span>
<span id="cb9-51"><a href="#cb9-51" tabindex="-1"></a>  <span class="dt">int</span> current <span class="op">=</span> seed<span class="op">;</span></span>
<span id="cb9-52"><a href="#cb9-52" tabindex="-1"></a>  visited<span class="op">[</span>current<span class="op">]</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb9-53"><a href="#cb9-53" tabindex="-1"></a></span>
<span id="cb9-54"><a href="#cb9-54" tabindex="-1"></a>  <span class="co">// Initialize with first site</span></span>
<span id="cb9-55"><a href="#cb9-55" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> sp <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> sp <span class="op">&lt;</span> n_species<span class="op">;</span> sp<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb9-56"><a href="#cb9-56" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>species_pa<span class="op">(</span>current<span class="op">,</span> sp<span class="op">)</span> <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-57"><a href="#cb9-57" tabindex="-1"></a>      prev_species<span class="op">.</span>insert<span class="op">(</span>sp<span class="op">);</span></span>
<span id="cb9-58"><a href="#cb9-58" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-59"><a href="#cb9-59" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb9-60"><a href="#cb9-60" tabindex="-1"></a></span>
<span id="cb9-61"><a href="#cb9-61" tabindex="-1"></a>  <span class="dt">double</span> cum_dist <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb9-62"><a href="#cb9-62" tabindex="-1"></a></span>
<span id="cb9-63"><a href="#cb9-63" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> step <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> step <span class="op">&lt;</span> n_sites <span class="op">-</span> <span class="dv">1</span><span class="op">;</span> step<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb9-64"><a href="#cb9-64" tabindex="-1"></a>    <span class="co">// Find next site (kNN logic)</span></span>
<span id="cb9-65"><a href="#cb9-65" tabindex="-1"></a>    <span class="dt">double</span> min_dist <span class="op">=</span> R_PosInf<span class="op">;</span></span>
<span id="cb9-66"><a href="#cb9-66" tabindex="-1"></a>    <span class="dt">int</span> next <span class="op">=</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb9-67"><a href="#cb9-67" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> n_sites<span class="op">;</span> j<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb9-68"><a href="#cb9-68" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(!</span>visited<span class="op">[</span>j<span class="op">]</span> <span class="op">&amp;&amp;</span> dist_mat<span class="op">(</span>current<span class="op">,</span> j<span class="op">)</span> <span class="op">&lt;</span> min_dist<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-69"><a href="#cb9-69" tabindex="-1"></a>        min_dist <span class="op">=</span> dist_mat<span class="op">(</span>current<span class="op">,</span> j<span class="op">);</span></span>
<span id="cb9-70"><a href="#cb9-70" tabindex="-1"></a>        next <span class="op">=</span> j<span class="op">;</span></span>
<span id="cb9-71"><a href="#cb9-71" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb9-72"><a href="#cb9-72" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-73"><a href="#cb9-73" tabindex="-1"></a></span>
<span id="cb9-74"><a href="#cb9-74" tabindex="-1"></a>    cum_dist <span class="op">+=</span> min_dist<span class="op">;</span></span>
<span id="cb9-75"><a href="#cb9-75" tabindex="-1"></a>    distances<span class="op">[</span>step<span class="op">]</span> <span class="op">=</span> cum_dist<span class="op">;</span></span>
<span id="cb9-76"><a href="#cb9-76" tabindex="-1"></a></span>
<span id="cb9-77"><a href="#cb9-77" tabindex="-1"></a>    <span class="co">// Get species at new site</span></span>
<span id="cb9-78"><a href="#cb9-78" tabindex="-1"></a>    curr_species<span class="op">.</span>clear<span class="op">();</span></span>
<span id="cb9-79"><a href="#cb9-79" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> sp <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> sp <span class="op">&lt;</span> n_species<span class="op">;</span> sp<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb9-80"><a href="#cb9-80" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>species_pa<span class="op">(</span>next<span class="op">,</span> sp<span class="op">)</span> <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-81"><a href="#cb9-81" tabindex="-1"></a>        curr_species<span class="op">.</span>insert<span class="op">(</span>sp<span class="op">);</span></span>
<span id="cb9-82"><a href="#cb9-82" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb9-83"><a href="#cb9-83" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-84"><a href="#cb9-84" tabindex="-1"></a></span>
<span id="cb9-85"><a href="#cb9-85" tabindex="-1"></a>    <span class="co">// Calculate pairwise beta between accumulated and new site</span></span>
<span id="cb9-86"><a href="#cb9-86" tabindex="-1"></a>    BetaResult beta <span class="op">=</span> calc_beta_sorensen<span class="op">(</span>prev_species<span class="op">,</span> curr_species<span class="op">);</span></span>
<span id="cb9-87"><a href="#cb9-87" tabindex="-1"></a>    beta_total<span class="op">[</span>step<span class="op">]</span> <span class="op">=</span> beta<span class="op">.</span>total<span class="op">;</span></span>
<span id="cb9-88"><a href="#cb9-88" tabindex="-1"></a>    beta_turn<span class="op">[</span>step<span class="op">]</span> <span class="op">=</span> beta<span class="op">.</span>turnover<span class="op">;</span></span>
<span id="cb9-89"><a href="#cb9-89" tabindex="-1"></a>    beta_nest<span class="op">[</span>step<span class="op">]</span> <span class="op">=</span> beta<span class="op">.</span>nestedness<span class="op">;</span></span>
<span id="cb9-90"><a href="#cb9-90" tabindex="-1"></a></span>
<span id="cb9-91"><a href="#cb9-91" tabindex="-1"></a>    <span class="co">// Update accumulated species set</span></span>
<span id="cb9-92"><a href="#cb9-92" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> sp <span class="op">:</span> curr_species<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-93"><a href="#cb9-93" tabindex="-1"></a>      prev_species<span class="op">.</span>insert<span class="op">(</span>sp<span class="op">);</span></span>
<span id="cb9-94"><a href="#cb9-94" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-95"><a href="#cb9-95" tabindex="-1"></a></span>
<span id="cb9-96"><a href="#cb9-96" tabindex="-1"></a>    current <span class="op">=</span> next<span class="op">;</span></span>
<span id="cb9-97"><a href="#cb9-97" tabindex="-1"></a>    visited<span class="op">[</span>current<span class="op">]</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb9-98"><a href="#cb9-98" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb9-99"><a href="#cb9-99" tabindex="-1"></a></span>
<span id="cb9-100"><a href="#cb9-100" tabindex="-1"></a>  <span class="cf">return</span> List<span class="op">::</span>create<span class="op">(</span></span>
<span id="cb9-101"><a href="#cb9-101" tabindex="-1"></a>    Named<span class="op">(</span><span class="st">"beta_total"</span><span class="op">)</span> <span class="op">=</span> beta_total<span class="op">,</span></span>
<span id="cb9-102"><a href="#cb9-102" tabindex="-1"></a>    Named<span class="op">(</span><span class="st">"beta_turnover"</span><span class="op">)</span> <span class="op">=</span> beta_turn<span class="op">,</span></span>
<span id="cb9-103"><a href="#cb9-103" tabindex="-1"></a>    Named<span class="op">(</span><span class="st">"beta_nestedness"</span><span class="op">)</span> <span class="op">=</span> beta_nest<span class="op">,</span></span>
<span id="cb9-104"><a href="#cb9-104" tabindex="-1"></a>    Named<span class="op">(</span><span class="st">"distance"</span><span class="op">)</span> <span class="op">=</span> distances</span>
<span id="cb9-105"><a href="#cb9-105" tabindex="-1"></a>  <span class="op">);</span></span>
<span id="cb9-106"><a href="#cb9-106" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="r-wrapper">R Wrapper<a class="anchor" aria-label="anchor" href="#r-wrapper"></a></h4>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">spaccBeta</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">coords</span>, <span class="va">method</span> <span class="op">=</span> <span class="st">"knn"</span>, <span class="va">n_seeds</span> <span class="op">=</span> <span class="fl">50</span>,</span>
<span>                      <span class="va">partition</span> <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">index</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sorensen"</span>, <span class="st">"jaccard"</span><span class="op">)</span>,</span>
<span>                      <span class="va">distance</span> <span class="op">=</span> <span class="st">"euclidean"</span>, <span class="va">progress</span> <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">seed</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span>  <span class="va">index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/match.arg.html" class="external-link">match.arg</a></span><span class="op">(</span><span class="va">index</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># ... validation ...</span></span>
<span></span>
<span>  <span class="va">results</span> <span class="op">&lt;-</span> <span class="fu">cpp_beta_parallel</span><span class="op">(</span><span class="va">species_pa</span>, <span class="va">dist_mat</span>, <span class="va">n_seeds</span>, <span class="va">index</span>, <span class="va">n_cores</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/structure.html" class="external-link">structure</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      beta_total <span class="op">=</span> <span class="va">results</span><span class="op">$</span><span class="va">total</span>,      <span class="co"># matrix: n_seeds x (n_sites-1)</span></span>
<span>      beta_turnover <span class="op">=</span> <span class="va">results</span><span class="op">$</span><span class="va">turnover</span>,</span>
<span>      beta_nestedness <span class="op">=</span> <span class="va">results</span><span class="op">$</span><span class="va">nestedness</span>,</span>
<span>      distance <span class="op">=</span> <span class="va">results</span><span class="op">$</span><span class="va">distance</span>,</span>
<span>      n_seeds <span class="op">=</span> <span class="va">n_seeds</span>,</span>
<span>      method <span class="op">=</span> <span class="va">method</span>,</span>
<span>      index <span class="op">=</span> <span class="va">index</span>,</span>
<span>      call <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/match.call.html" class="external-link">match.call</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">)</span>,</span>
<span>    class <span class="op">=</span> <span class="st">"spacc_beta"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="plot-method-1">Plot Method<a class="anchor" aria-label="anchor" href="#plot-method-1"></a></h4>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot.spacc_beta</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">partition</span> <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">xaxis</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sites"</span>, <span class="st">"distance"</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">xaxis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/match.arg.html" class="external-link">match.arg</a></span><span class="op">(</span><span class="va">xaxis</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Summarize across seeds</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="va">xaxis</span> <span class="op">==</span> <span class="st">"sites"</span><span class="op">)</span> <span class="fl">2</span><span class="op">:</span><span class="va">x</span><span class="op">$</span><span class="va">n_sites</span> <span class="kw">else</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">distance</span><span class="op">)</span>,</span>
<span>    total <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">beta_total</span><span class="op">)</span>,</span>
<span>    turnover <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">beta_turnover</span><span class="op">)</span>,</span>
<span>    nestedness <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colMeans</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">beta_nestedness</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">partition</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Stacked area chart: turnover + nestedness = total</span></span>
<span>    <span class="co"># Or line plot with three lines</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="co"># Just total beta</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<hr></div>
</div>
</div>
<div class="section level2">
<h2 id="feature-3-coverage-based-spatial-rarefaction">Feature 3: Coverage-Based Spatial Rarefaction<a class="anchor" aria-label="anchor" href="#feature-3-coverage-based-spatial-rarefaction"></a></h2>
<div class="section level3">
<h3 id="background-2">Background<a class="anchor" aria-label="anchor" href="#background-2"></a></h3>
<p>Chao &amp; Jost (2012): Sample completeness (coverage) is better than sample size for standardization.</p>
<p>Coverage = proportion of total community abundance represented by observed species. <code>C = 1 - (f1/n)</code> where f1 = singletons, n = total individuals (simplified)</p>
</div>
<div class="section level3">
<h3 id="api-design-2">API Design<a class="anchor" aria-label="anchor" href="#api-design-2"></a></h3>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Add standardize parameter to spacc()</span></span>
<span><span class="fu"><a href="reference/spacc.html">spacc</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">coords</span>, method <span class="op">=</span> <span class="st">"knn"</span>, standardize <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sites"</span>, <span class="st">"coverage"</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Or separate function</span></span>
<span><span class="fu"><a href="reference/spaccCoverage.html">spaccCoverage</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">coords</span>, method <span class="op">=</span> <span class="st">"knn"</span>, target_coverage <span class="op">=</span> <span class="fl">0.95</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="implementation-2">Implementation<a class="anchor" aria-label="anchor" href="#implementation-2"></a></h3>
<div class="section level4">
<h4 id="coverage-calculation-chao--jost-2012">Coverage Calculation (Chao &amp; Jost 2012)<a class="anchor" aria-label="anchor" href="#coverage-calculation-chao--jost-2012"></a></h4>
<div class="sourceCode" id="cb13"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="co">// Good-Turing coverage estimator</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="dt">double</span> calc_coverage<span class="op">(</span><span class="at">const</span> <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;&amp;</span> abundances<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>  <span class="dt">int</span> n <span class="op">=</span> <span class="dv">0</span><span class="op">;</span>  <span class="co">// total individuals</span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>  <span class="dt">int</span> f1 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="co">// singletons</span></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>  <span class="dt">int</span> f2 <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="co">// doubletons</span></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> a <span class="op">:</span> abundances<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>    n <span class="op">+=</span> a<span class="op">;</span></span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>a <span class="op">==</span> <span class="dv">1</span><span class="op">)</span> f1<span class="op">++;</span></span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>a <span class="op">==</span> <span class="dv">2</span><span class="op">)</span> f2<span class="op">++;</span></span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>n <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="cf">return</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a>  <span class="co">// Chao &amp; Jost estimator</span></span>
<span id="cb13-16"><a href="#cb13-16" tabindex="-1"></a>  <span class="dt">double</span> C<span class="op">;</span></span>
<span id="cb13-17"><a href="#cb13-17" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>f2 <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-18"><a href="#cb13-18" tabindex="-1"></a>    C <span class="op">=</span> <span class="fl">1.0</span> <span class="op">-</span> <span class="op">(</span><span class="dt">double</span><span class="op">)</span>f1 <span class="op">/</span> n <span class="op">*</span> <span class="op">((</span>n <span class="op">-</span> <span class="fl">1.0</span><span class="op">)</span> <span class="op">*</span> f1 <span class="op">/</span> <span class="op">((</span>n <span class="op">-</span> <span class="fl">1.0</span><span class="op">)</span> <span class="op">*</span> f1 <span class="op">+</span> <span class="fl">2.0</span> <span class="op">*</span> f2<span class="op">));</span></span>
<span id="cb13-19"><a href="#cb13-19" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb13-20"><a href="#cb13-20" tabindex="-1"></a>    C <span class="op">=</span> <span class="fl">1.0</span> <span class="op">-</span> <span class="op">(</span><span class="dt">double</span><span class="op">)</span>f1 <span class="op">/</span> n <span class="op">*</span> <span class="op">((</span>n <span class="op">-</span> <span class="fl">1.0</span><span class="op">)</span> <span class="op">/</span> n<span class="op">);</span></span>
<span id="cb13-21"><a href="#cb13-21" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb13-22"><a href="#cb13-22" tabindex="-1"></a></span>
<span id="cb13-23"><a href="#cb13-23" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">std::</span>max<span class="op">(</span><span class="fl">0.0</span><span class="op">,</span> <span class="bu">std::</span>min<span class="op">(</span><span class="fl">1.0</span><span class="op">,</span> C<span class="op">));</span></span>
<span id="cb13-24"><a href="#cb13-24" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="spatial-accumulation-with-coverage">Spatial Accumulation with Coverage<a class="anchor" aria-label="anchor" href="#spatial-accumulation-with-coverage"></a></h4>
<div class="sourceCode" id="cb14"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>List cpp_knn_coverage<span class="op">(</span>IntegerMatrix species_mat<span class="op">,</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>                      NumericMatrix dist_mat<span class="op">,</span></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>                      <span class="dt">int</span> seed<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>  <span class="dt">int</span> n_sites <span class="op">=</span> species_mat<span class="op">.</span>nrow<span class="op">();</span></span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>  <span class="dt">int</span> n_species <span class="op">=</span> species_mat<span class="op">.</span>ncol<span class="op">();</span></span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>  IntegerVector richness<span class="op">(</span>n_sites<span class="op">);</span></span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a>  NumericVector coverage<span class="op">(</span>n_sites<span class="op">);</span></span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">bool</span><span class="op">&gt;</span> visited<span class="op">(</span>n_sites<span class="op">,</span> <span class="kw">false</span><span class="op">);</span></span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> cumulative<span class="op">(</span>n_species<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a>  <span class="dt">int</span> current <span class="op">=</span> seed<span class="op">;</span></span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a>  visited<span class="op">[</span>current<span class="op">]</span> <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb14-15"><a href="#cb14-15" tabindex="-1"></a></span>
<span id="cb14-16"><a href="#cb14-16" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> sp <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> sp <span class="op">&lt;</span> n_species<span class="op">;</span> sp<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb14-17"><a href="#cb14-17" tabindex="-1"></a>    cumulative<span class="op">[</span>sp<span class="op">]</span> <span class="op">+=</span> species_mat<span class="op">(</span>current<span class="op">,</span> sp<span class="op">);</span></span>
<span id="cb14-18"><a href="#cb14-18" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb14-19"><a href="#cb14-19" tabindex="-1"></a></span>
<span id="cb14-20"><a href="#cb14-20" tabindex="-1"></a>  richness<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> count_species<span class="op">(</span>cumulative<span class="op">);</span></span>
<span id="cb14-21"><a href="#cb14-21" tabindex="-1"></a>  coverage<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> calc_coverage<span class="op">(</span>cumulative<span class="op">);</span></span>
<span id="cb14-22"><a href="#cb14-22" tabindex="-1"></a></span>
<span id="cb14-23"><a href="#cb14-23" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> step <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> step <span class="op">&lt;</span> n_sites<span class="op">;</span> step<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb14-24"><a href="#cb14-24" tabindex="-1"></a>    <span class="co">// kNN logic to find next site</span></span>
<span id="cb14-25"><a href="#cb14-25" tabindex="-1"></a>    <span class="co">// ...</span></span>
<span id="cb14-26"><a href="#cb14-26" tabindex="-1"></a></span>
<span id="cb14-27"><a href="#cb14-27" tabindex="-1"></a>    <span class="co">// Update cumulative abundances</span></span>
<span id="cb14-28"><a href="#cb14-28" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> sp <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> sp <span class="op">&lt;</span> n_species<span class="op">;</span> sp<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb14-29"><a href="#cb14-29" tabindex="-1"></a>      cumulative<span class="op">[</span>sp<span class="op">]</span> <span class="op">+=</span> species_mat<span class="op">(</span>current<span class="op">,</span> sp<span class="op">);</span></span>
<span id="cb14-30"><a href="#cb14-30" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-31"><a href="#cb14-31" tabindex="-1"></a></span>
<span id="cb14-32"><a href="#cb14-32" tabindex="-1"></a>    richness<span class="op">[</span>step<span class="op">]</span> <span class="op">=</span> count_species<span class="op">(</span>cumulative<span class="op">);</span></span>
<span id="cb14-33"><a href="#cb14-33" tabindex="-1"></a>    coverage<span class="op">[</span>step<span class="op">]</span> <span class="op">=</span> calc_coverage<span class="op">(</span>cumulative<span class="op">);</span></span>
<span id="cb14-34"><a href="#cb14-34" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb14-35"><a href="#cb14-35" tabindex="-1"></a></span>
<span id="cb14-36"><a href="#cb14-36" tabindex="-1"></a>  <span class="cf">return</span> List<span class="op">::</span>create<span class="op">(</span></span>
<span id="cb14-37"><a href="#cb14-37" tabindex="-1"></a>    Named<span class="op">(</span><span class="st">"richness"</span><span class="op">)</span> <span class="op">=</span> richness<span class="op">,</span></span>
<span id="cb14-38"><a href="#cb14-38" tabindex="-1"></a>    Named<span class="op">(</span><span class="st">"coverage"</span><span class="op">)</span> <span class="op">=</span> coverage</span>
<span id="cb14-39"><a href="#cb14-39" tabindex="-1"></a>  <span class="op">);</span></span>
<span id="cb14-40"><a href="#cb14-40" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="interpolation-to-target-coverage">Interpolation to Target Coverage<a class="anchor" aria-label="anchor" href="#interpolation-to-target-coverage"></a></h4>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Interpolate richness at target coverage levels</span></span>
<span><span class="va">interpolate_coverage</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">richness</span>, <span class="va">coverage</span>, <span class="va">target</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.9</span>, <span class="fl">0.95</span>, <span class="fl">0.99</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">target</span>, <span class="kw">function</span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">coverage</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">t</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/approxfun.html" class="external-link">approx</a></span><span class="op">(</span><span class="va">coverage</span>, <span class="va">richness</span>, xout <span class="op">=</span> <span class="va">t</span><span class="op">)</span><span class="op">$</span><span class="va">y</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<hr></div>
</div>
</div>
<div class="section level2">
<h2 id="feature-4-phylogenetic--functional-diversity">Feature 4: Phylogenetic &amp; Functional Diversity<a class="anchor" aria-label="anchor" href="#feature-4-phylogenetic--functional-diversity"></a></h2>
<div class="section level3">
<h3 id="background-3">Background<a class="anchor" aria-label="anchor" href="#background-3"></a></h3>
<ul><li>
<strong>Faith’s PD</strong>: Sum of branch lengths connecting species in a sample</li>
<li>
<strong>Functional Diversity (FD)</strong>: Trait-based diversity (e.g., functional richness, dispersion)</li>
</ul></div>
<div class="section level3">
<h3 id="api-design-3">API Design<a class="anchor" aria-label="anchor" href="#api-design-3"></a></h3>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Phylogenetic</span></span>
<span><span class="fu"><a href="reference/spaccPhylo.html">spaccPhylo</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">coords</span>, <span class="va">tree</span>, method <span class="op">=</span> <span class="st">"knn"</span>, metric <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PD"</span>, <span class="st">"MPD"</span>, <span class="st">"MNTD"</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Functional</span></span>
<span><span class="fu"><a href="reference/spaccFunc.html">spaccFunc</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">coords</span>, <span class="va">traits</span>, method <span class="op">=</span> <span class="st">"knn"</span>, metric <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"FRic"</span>, <span class="st">"FDiv"</span>, <span class="st">"FDis"</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="dependencies">Dependencies<a class="anchor" aria-label="anchor" href="#dependencies"></a></h3>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>Suggests<span class="sc">:</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>    ape,        <span class="co"># phylogenetic trees</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>    picante,    <span class="co"># PD calculations (optional, can implement ourselves)</span></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>    FD,         <span class="co"># functional diversity</span></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a>    geometry    <span class="co"># convex hulls for FRic</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="phylogenetic-implementation">Phylogenetic Implementation<a class="anchor" aria-label="anchor" href="#phylogenetic-implementation"></a></h3>
<div class="section level4">
<h4 id="faiths-pd-calculation">Faith’s PD Calculation<a class="anchor" aria-label="anchor" href="#faiths-pd-calculation"></a></h4>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Using ape for tree manipulation</span></span>
<span><span class="va">calc_pd</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">tree</span>, <span class="va">tips</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">tips</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">tips</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># PD of single tip = edge length to root</span></span>
<span>    <span class="va">node</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">tree</span><span class="op">$</span><span class="va">tip.label</span> <span class="op">==</span> <span class="va">tips</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/node.depth.html" class="external-link">node.depth.edgelength</a></span><span class="op">(</span><span class="va">tree</span><span class="op">)</span><span class="op">[</span><span class="va">node</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Prune tree to tips</span></span>
<span>  <span class="va">subtree</span> <span class="op">&lt;-</span> <span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/drop.tip.html" class="external-link">keep.tip</a></span><span class="op">(</span><span class="va">tree</span>, <span class="va">tips</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">subtree</span><span class="op">$</span><span class="va">edge.length</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="c-implementation-for-performance">C++ Implementation for Performance<a class="anchor" aria-label="anchor" href="#c-implementation-for-performance"></a></h4>
<div class="sourceCode" id="cb19"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="co">// Pre-compute pairwise phylogenetic distances</span></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a><span class="co">// Then PD = sum of unique branch lengths</span></span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a><span class="co">// Alternative: cophenetic distance matrix approach</span></span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a><span class="co">// MPD = mean pairwise phylogenetic distance</span></span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a><span class="dt">double</span> calc_mpd<span class="op">(</span><span class="at">const</span> NumericMatrix<span class="op">&amp;</span> phylo_dist<span class="op">,</span></span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a>                <span class="at">const</span> <span class="bu">std::</span>set<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;&amp;</span> species<span class="op">)</span> <span class="op">{</span></span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>species<span class="op">.</span>size<span class="op">()</span> <span class="op">&lt;</span> <span class="dv">2</span><span class="op">)</span> <span class="cf">return</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a>  <span class="dt">double</span> sum <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb19-11"><a href="#cb19-11" tabindex="-1"></a>  <span class="dt">int</span> count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb19-12"><a href="#cb19-12" tabindex="-1"></a></span>
<span id="cb19-13"><a href="#cb19-13" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;</span> spp<span class="op">(</span>species<span class="op">.</span>begin<span class="op">(),</span> species<span class="op">.</span>end<span class="op">());</span></span>
<span id="cb19-14"><a href="#cb19-14" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> spp<span class="op">.</span>size<span class="op">();</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb19-15"><a href="#cb19-15" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">size_t</span> j <span class="op">=</span> i <span class="op">+</span> <span class="dv">1</span><span class="op">;</span> j <span class="op">&lt;</span> spp<span class="op">.</span>size<span class="op">();</span> j<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb19-16"><a href="#cb19-16" tabindex="-1"></a>      sum <span class="op">+=</span> phylo_dist<span class="op">(</span>spp<span class="op">[</span>i<span class="op">],</span> spp<span class="op">[</span>j<span class="op">]);</span></span>
<span id="cb19-17"><a href="#cb19-17" tabindex="-1"></a>      count<span class="op">++;</span></span>
<span id="cb19-18"><a href="#cb19-18" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb19-19"><a href="#cb19-19" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb19-20"><a href="#cb19-20" tabindex="-1"></a></span>
<span id="cb19-21"><a href="#cb19-21" tabindex="-1"></a>  <span class="cf">return</span> sum <span class="op">/</span> count<span class="op">;</span></span>
<span id="cb19-22"><a href="#cb19-22" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="spatial-pd-accumulation">Spatial PD Accumulation<a class="anchor" aria-label="anchor" href="#spatial-pd-accumulation"></a></h4>
<div class="sourceCode" id="cb20"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>NumericVector cpp_pd_accumulation<span class="op">(</span>IntegerMatrix species_pa<span class="op">,</span></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a>                                   NumericMatrix dist_mat<span class="op">,</span></span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a>                                   NumericMatrix phylo_dist<span class="op">,</span></span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a>                                   NumericVector edge_lengths<span class="op">,</span></span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a>                                   <span class="dt">int</span> seed<span class="op">)</span> <span class="op">{</span></span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a>  <span class="co">// Track which edges are "activated" as species accumulate</span></span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a>  <span class="co">// PD = sum of activated edge lengths</span></span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a>  <span class="co">// Implementation depends on tree structure</span></span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a>  <span class="co">// May need to pass tree as edge list</span></span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="functional-diversity-implementation">Functional Diversity Implementation<a class="anchor" aria-label="anchor" href="#functional-diversity-implementation"></a></h3>
<div class="section level4">
<h4 id="functional-richness-convex-hull-volume">Functional Richness (Convex Hull Volume)<a class="anchor" aria-label="anchor" href="#functional-richness-convex-hull-volume"></a></h4>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">calc_fric</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">traits</span>, <span class="va">species_present</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">trait_subset</span> <span class="op">&lt;-</span> <span class="va">traits</span><span class="op">[</span><span class="va">species_present</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">trait_subset</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">trait_subset</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">NA</span><span class="op">)</span>  <span class="co"># Need more species than traits for convex hull</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Convex hull volume</span></span>
<span>  <span class="va">hull</span> <span class="op">&lt;-</span> <span class="fu">geometry</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/geometry/man/convhulln.html" class="external-link">convhulln</a></span><span class="op">(</span><span class="va">trait_subset</span>, options <span class="op">=</span> <span class="st">"FA"</span><span class="op">)</span></span>
<span>  <span class="va">hull</span><span class="op">$</span><span class="va">vol</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="functional-dispersion">Functional Dispersion<a class="anchor" aria-label="anchor" href="#functional-dispersion"></a></h4>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">calc_fdis</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">traits</span>, <span class="va">species_present</span>, <span class="va">abundances</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">trait_subset</span> <span class="op">&lt;-</span> <span class="va">traits</span><span class="op">[</span><span class="va">species_present</span>, , drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">abundances</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">abundances</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">trait_subset</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># Weighted centroid</span></span>
<span>  <span class="va">centroid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">colSums</a></span><span class="op">(</span><span class="va">trait_subset</span> <span class="op">*</span> <span class="va">abundances</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">abundances</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Mean distance to centroid</span></span>
<span>  <span class="va">dists</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowSums</a></span><span class="op">(</span><span class="op">(</span><span class="va">trait_subset</span> <span class="op">-</span> <span class="va">centroid</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">dists</span> <span class="op">*</span> <span class="va">abundances</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">abundances</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<hr></div>
</div>
</div>
<div class="section level2">
<h2 id="file-structure-after-implementation">File Structure After Implementation<a class="anchor" aria-label="anchor" href="#file-structure-after-implementation"></a></h2>
<pre><code>spacc/
├── R/
│   ├── spacc.R           # Updated: add q parameter
│   ├── spaccBeta.R       # NEW: beta diversity accumulation
│   ├── spaccCoverage.R   # NEW: coverage-based methods
│   ├── spaccPhylo.R      # NEW: phylogenetic diversity
│   ├── spaccFunc.R       # NEW: functional diversity
│   ├── hill.R            # NEW: Hill number utilities
│   └── ...
├── src/
│   ├── hill.cpp          # NEW: Hill number calculations
│   ├── beta.cpp          # NEW: beta diversity calculations
│   ├── coverage.cpp      # NEW: coverage estimation
│   ├── phylo.cpp         # NEW: PD calculations (optional)
│   └── ...
└── tests/testthat/
    ├── test-hill.R       # NEW
    ├── test-beta.R       # NEW
    ├── test-coverage.R   # NEW
    ├── test-phylo.R      # NEW
    └── ...</code></pre>
<hr></div>
<div class="section level2">
<h2 id="implementation-order">Implementation Order<a class="anchor" aria-label="anchor" href="#implementation-order"></a></h2>
<div class="section level3">
<h3 id="phase-1-hill-numbers-week-1-2">Phase 1: Hill Numbers (Week 1-2)<a class="anchor" aria-label="anchor" href="#phase-1-hill-numbers-week-1-2"></a></h3>
<ol style="list-style-type: decimal"><li>Add <code>calc_hill()</code> C++ function</li>
<li>Modify <code>cpp_knn_single</code> to track abundances</li>
<li>Create <code>cpp_knn_hill_parallel</code>
</li>
<li>Update R wrapper with <code>q</code> parameter</li>
<li>Add plot method for multiple q values</li>
<li>Write tests comparing to vegan::diversity()</li>
<li>Document</li>
</ol></div>
<div class="section level3">
<h3 id="phase-2-spatial-beta-diversity-week-2-3">Phase 2: Spatial Beta Diversity (Week 2-3)<a class="anchor" aria-label="anchor" href="#phase-2-spatial-beta-diversity-week-2-3"></a></h3>
<ol style="list-style-type: decimal"><li>Implement <code>calc_beta_sorensen()</code> in C++</li>
<li>Create <code>cpp_beta_accumulation()</code>
</li>
<li>Add parallel version</li>
<li>Create <code><a href="reference/spaccBeta.html">spaccBeta()</a></code> R function</li>
<li>Implement S3 methods (print, summary, plot)</li>
<li>Write tests comparing to betapart</li>
<li>Document</li>
</ol></div>
<div class="section level3">
<h3 id="phase-3-coverage-based-rarefaction-week-3">Phase 3: Coverage-Based Rarefaction (Week 3)<a class="anchor" aria-label="anchor" href="#phase-3-coverage-based-rarefaction-week-3"></a></h3>
<ol style="list-style-type: decimal"><li>Implement <code>calc_coverage()</code> in C++</li>
<li>Add coverage tracking to existing methods</li>
<li>Create interpolation function</li>
<li>Update spacc() or create spaccCoverage()</li>
<li>Write tests comparing to iNEXT</li>
<li>Document</li>
</ol></div>
<div class="section level3">
<h3 id="phase-4-phylogeneticfunctional-week-4-5">Phase 4: Phylogenetic/Functional (Week 4-5)<a class="anchor" aria-label="anchor" href="#phase-4-phylogeneticfunctional-week-4-5"></a></h3>
<ol style="list-style-type: decimal"><li>Design tree input format (ape::phylo)</li>
<li>Implement PD accumulation (start with R, optimize to C++ if needed)</li>
<li>Implement FD accumulation</li>
<li>Create spaccPhylo() and spaccFunc()</li>
<li>Write tests comparing to picante/FD</li>
<li>Document</li>
</ol><hr></div>
</div>
<div class="section level2">
<h2 id="testing-strategy">Testing Strategy<a class="anchor" aria-label="anchor" href="#testing-strategy"></a></h2>
<div class="section level3">
<h3 id="unit-tests">Unit Tests<a class="anchor" aria-label="anchor" href="#unit-tests"></a></h3>
<ul><li>Each C++ function has corresponding R test</li>
<li>Compare against reference implementations (vegan, iNEXT, betapart, picante)</li>
<li>Edge cases: empty data, single species, single site</li>
</ul></div>
<div class="section level3">
<h3 id="integration-tests">Integration Tests<a class="anchor" aria-label="anchor" href="#integration-tests"></a></h3>
<ul><li>Full workflow tests with simulated data</li>
<li>Verify plot methods don’t error</li>
<li>Check parallel vs sequential give same results</li>
</ul></div>
<div class="section level3">
<h3 id="performance-tests">Performance Tests<a class="anchor" aria-label="anchor" href="#performance-tests"></a></h3>
<ul><li>Benchmark against mobr, vegan</li>
<li>Document speedups in vignette</li>
</ul><hr></div>
</div>
<div class="section level2">
<h2 id="documentation-plan">Documentation Plan<a class="anchor" aria-label="anchor" href="#documentation-plan"></a></h2>
<div class="section level3">
<h3 id="function-documentation">Function Documentation<a class="anchor" aria-label="anchor" href="#function-documentation"></a></h3>
<ul><li>All exported functions have roxygen2 docs</li>
<li>Examples for each function</li>
<li>Cross-references with @seealso</li>
</ul></div>
<div class="section level3">
<h3 id="vignette-comprehensive-spatial-diversity-analysis">Vignette: “Comprehensive Spatial Diversity Analysis”<a class="anchor" aria-label="anchor" href="#vignette-comprehensive-spatial-diversity-analysis"></a></h3>
<ol style="list-style-type: decimal"><li>
<strong>Introduction</strong>: Why spatial matters</li>
<li>
<strong>Basic Usage</strong>: spacc() with richness</li>
<li>
<strong>Hill Numbers</strong>: Comparing q=0,1,2</li>
<li>
<strong>Beta Diversity</strong>: Turnover vs nestedness</li>
<li>
<strong>Coverage-Based</strong>: When to use</li>
<li>
<strong>Phylogenetic/Functional</strong>: Advanced applications</li>
<li>
<strong>Performance</strong>: Benchmarks vs alternatives</li>
<li>
<strong>Case Study</strong>: Real ecological dataset</li>
</ol><hr></div>
</div>
<div class="section level2">
<h2 id="paper-outline-mee-application">Paper Outline (MEE Application)<a class="anchor" aria-label="anchor" href="#paper-outline-mee-application"></a></h2>
<p><strong>Title</strong>: “spacc: Fast spatial diversity accumulation with Hill numbers, beta partitioning, and phylogenetic extensions”</p>
<ol style="list-style-type: decimal"><li>
<strong>Introduction</strong> (500 words)
<ul><li>SACs and their limitations</li>
<li>Spatial structure matters</li>
<li>Gap: no fast, comprehensive tool</li>
</ul></li>
<li>
<strong>Methods</strong> (1500 words)
<ul><li>Hill number spatial accumulation</li>
<li>Beta diversity partitioning</li>
<li>Coverage standardization</li>
<li>Phylogenetic/functional extensions</li>
<li>C++ implementation</li>
</ul></li>
<li>
<strong>Results</strong> (1000 words)
<ul><li>Simulation study: bias of random vs spatial</li>
<li>Benchmark: performance vs mobr/vegan</li>
<li>Case study: real dataset</li>
</ul></li>
<li>
<strong>Discussion</strong> (500 words)
<ul><li>When to use which method</li>
<li>Limitations</li>
<li>Future directions</li>
</ul></li>
<li>
<strong>Figures</strong>
<ul><li>Fig 1: Conceptual diagram of spatial vs random SAC</li>
<li>Fig 2: Hill numbers reveal scale-dependent patterns</li>
<li>Fig 3: Beta partitioning example</li>
<li>Fig 4: Performance benchmarks</li>
</ul></li>
</ol><hr></div>
<div class="section level2">
<h2 id="version-milestones">Version Milestones<a class="anchor" aria-label="anchor" href="#version-milestones"></a></h2>
<div class="section level3">
<h3 id="v020---hill-numbers">v0.2.0 - Hill Numbers<a class="anchor" aria-label="anchor" href="#v020---hill-numbers"></a></h3>
<ul><li>
<code>q</code> parameter in spacc()</li>
<li>Basic Hill number support</li>
</ul></div>
<div class="section level3">
<h3 id="v030---beta-diversity">v0.3.0 - Beta Diversity<a class="anchor" aria-label="anchor" href="#v030---beta-diversity"></a></h3>
<ul><li>
<code><a href="reference/spaccBeta.html">spaccBeta()</a></code> function</li>
<li>Turnover/nestedness partitioning</li>
</ul></div>
<div class="section level3">
<h3 id="v040---coverage">v0.4.0 - Coverage<a class="anchor" aria-label="anchor" href="#v040---coverage"></a></h3>
<ul><li>Coverage-based standardization</li>
<li>Interpolation to target coverage</li>
</ul></div>
<div class="section level3">
<h3 id="v050---phylogeneticfunctional">v0.5.0 - Phylogenetic/Functional<a class="anchor" aria-label="anchor" href="#v050---phylogeneticfunctional"></a></h3>
<ul><li>
<code><a href="reference/spaccPhylo.html">spaccPhylo()</a></code> and <code><a href="reference/spaccFunc.html">spaccFunc()</a></code>
</li>
<li>Requires ape, geometry in Suggests</li>
</ul></div>
<div class="section level3">
<h3 id="v100---paper-release">v1.0.0 - Paper Release<a class="anchor" aria-label="anchor" href="#v100---paper-release"></a></h3>
<ul><li>Full documentation</li>
<li>Vignette</li>
<li>CRAN submission</li>
<li>MEE submission</li>
</ul></div>
</div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Gilles Colling.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer></div>





  
</body></html>

